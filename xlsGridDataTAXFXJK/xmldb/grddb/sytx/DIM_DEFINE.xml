<?xml version='1.0' encoding='GBK'?><mdroot><grdds>
<ROWSET>
<ROW num="0" ><MWTYP >F</MWTYP><MWID >DIM_DEFINE</MWID><NAME >模型定义</NAME><NOTE ></NOTE><NOACCNAME >1</NOACCNAME><FILE >DIM_DEFINE.zxg</FILE><SCENE ></SCENE><FIXED ></FIXED><CATTYP ></CATTYP><DTLRNG ></DTLRNG><BATINP ></BATINP><MANUNIT ></MANUNIT><USESMLUNT ></USESMLUNT><ITEMTABLE ></ITEMTABLE><BILHDRTABLE >DIM_MODEL</BILHDRTABLE><BILDTLTABLE ></BILDTLTABLE><COLLIST >GUID 内部唯一编号,ID 编号,NAME 名称,SOURCEDS 数据源,NOTE 说明,CRTUSER 创建人,TO_CHAR(CRTDAT,&amp;apos;YYYY-MM-DD HH24:MI:SS&amp;apos;) 创建时间</COLLIST><WHERE >1=1</WHERE><ORDER ></ORDER><DBNAME ></DBNAME><LISTSUM ></LISTSUM><LOADDATA ></LOADDATA><CHECKTITLE ></CHECKTITLE><IFBILL ></IFBILL><EXTJS ></EXTJS><JAVACLS ></JAVACLS><syt >x</syt></ROW>
</ROWSET>
</grdds><grdcelds>
<ROWSET>
<ROW num="0" ><ID >0,2,1</ID><CELLID ></CELLID><NAME >GUID</NAME><VALFLD >GUID</VALFLD><DEFVAL ></DEFVAL><NOTNULL ></NOTNULL><VALTYP ></VALTYP><MAXLEN ></MAXLEN><CTLTYP ></CTLTYP><LISTID ></LISTID><WHERE ></WHERE><ORDER ></ORDER><IFQUERY ></IFQUERY><IFQUERYSCOPE ></IFQUERYSCOPE><QUERTDEFVAL ></QUERTDEFVAL><FLD ></FLD><C17 ></C17><C18 >0,2,1</C18></ROW>
<ROW num="1" ><ID >0,3,1</ID><CELLID ></CELLID><NAME >系统号</NAME><VALFLD >SYTID</VALFLD><DEFVAL >[%SYS_SYTID]</DEFVAL><NOTNULL ></NOTNULL><VALTYP ></VALTYP><MAXLEN ></MAXLEN><CTLTYP ></CTLTYP><LISTID ></LISTID><WHERE ></WHERE><ORDER ></ORDER><IFQUERY ></IFQUERY><IFQUERYSCOPE ></IFQUERYSCOPE><QUERTDEFVAL ></QUERTDEFVAL><FLD ></FLD><C17 ></C17><C18 >0,3,1</C18></ROW>
<ROW num="2" ><ID >0,4,1</ID><CELLID ></CELLID><NAME >模型ID</NAME><VALFLD >ID</VALFLD><DEFVAL ></DEFVAL><NOTNULL ></NOTNULL><VALTYP ></VALTYP><MAXLEN ></MAXLEN><CTLTYP ></CTLTYP><LISTID ></LISTID><WHERE ></WHERE><ORDER ></ORDER><IFQUERY ></IFQUERY><IFQUERYSCOPE ></IFQUERYSCOPE><QUERTDEFVAL ></QUERTDEFVAL><FLD ></FLD><C17 ></C17><C18 >0,4,1</C18></ROW>
<ROW num="3" ><ID >0,5,1</ID><CELLID ></CELLID><NAME >模型名称</NAME><VALFLD >NAME</VALFLD><DEFVAL ></DEFVAL><NOTNULL ></NOTNULL><VALTYP ></VALTYP><MAXLEN ></MAXLEN><CTLTYP ></CTLTYP><LISTID ></LISTID><WHERE ></WHERE><ORDER ></ORDER><IFQUERY ></IFQUERY><IFQUERYSCOPE ></IFQUERYSCOPE><QUERTDEFVAL ></QUERTDEFVAL><FLD ></FLD><C17 ></C17><C18 >0,5,1</C18></ROW>
<ROW num="4" ><ID >0,6,1</ID><CELLID ></CELLID><NAME >数据源</NAME><VALFLD >SOURCEDS</VALFLD><DEFVAL ></DEFVAL><NOTNULL ></NOTNULL><VALTYP ></VALTYP><MAXLEN ></MAXLEN><CTLTYP ></CTLTYP><LISTID ></LISTID><WHERE ></WHERE><ORDER ></ORDER><IFQUERY ></IFQUERY><IFQUERYSCOPE ></IFQUERYSCOPE><QUERTDEFVAL ></QUERTDEFVAL><FLD ></FLD><C17 ></C17><C18 >0,6,1</C18></ROW>
<ROW num="5" ><ID >0,7,1</ID><CELLID ></CELLID><NAME >说明</NAME><VALFLD >NOTE</VALFLD><DEFVAL ></DEFVAL><NOTNULL ></NOTNULL><VALTYP ></VALTYP><MAXLEN ></MAXLEN><CTLTYP ></CTLTYP><LISTID ></LISTID><WHERE ></WHERE><ORDER ></ORDER><IFQUERY ></IFQUERY><IFQUERYSCOPE ></IFQUERYSCOPE><QUERTDEFVAL ></QUERTDEFVAL><FLD ></FLD><C17 ></C17><C18 >0,7,1</C18></ROW>
<ROW num="6" ><ID >0,9,1</ID><CELLID ></CELLID><NAME >创建人</NAME><VALFLD >CRTUSER</VALFLD><DEFVAL >[%SYS_USRID]</DEFVAL><NOTNULL ></NOTNULL><VALTYP ></VALTYP><MAXLEN ></MAXLEN><CTLTYP ></CTLTYP><LISTID ></LISTID><WHERE ></WHERE><ORDER ></ORDER><IFQUERY ></IFQUERY><IFQUERYSCOPE ></IFQUERYSCOPE><QUERTDEFVAL ></QUERTDEFVAL><FLD ></FLD><C17 ></C17><C18 >0,9,1</C18></ROW>
<ROW num="7" ><ID >0,3,2</ID><CELLID ></CELLID><NAME >组织号</NAME><VALFLD >ORGID</VALFLD><DEFVAL >[%SYS_ORGID]</DEFVAL><NOTNULL ></NOTNULL><VALTYP ></VALTYP><MAXLEN ></MAXLEN><CTLTYP ></CTLTYP><LISTID ></LISTID><WHERE ></WHERE><ORDER ></ORDER><IFQUERY ></IFQUERY><IFQUERYSCOPE ></IFQUERYSCOPE><QUERTDEFVAL ></QUERTDEFVAL><FLD ></FLD><C17 >0,3,2</C17><C18 >0,3,2</C18></ROW>
<ROW num="8" ><ID >0,3,3</ID><CELLID ></CELLID><NAME >帐套号</NAME><VALFLD >ACCID</VALFLD><DEFVAL >[%SYS_ACCID]</DEFVAL><NOTNULL >0</NOTNULL><VALTYP ></VALTYP><MAXLEN ></MAXLEN><CTLTYP ></CTLTYP><LISTID ></LISTID><WHERE ></WHERE><ORDER ></ORDER><IFQUERY ></IFQUERY><IFQUERYSCOPE ></IFQUERYSCOPE><QUERTDEFVAL ></QUERTDEFVAL><FLD ></FLD><C17 ></C17><C18 >0,3,3</C18></ROW>
</ROWSET>
</grdcelds><grdjsds>
<ROWSET>
<ROW num="0" ><GRDJSDS_VALUE >var sheet = 0;
var b_first = true;
var g_sourceds = &amp;quot;&amp;quot;;
var g_sourcexml = &amp;quot;&amp;quot;;

//数据加载完毕
function _thisOnpost_loaddata(sheet)
{
	if (b_first) {
		_this.SplitSheet(sheet,&amp;quot;H&amp;quot;,&amp;quot;28%&amp;quot;);
		_this.SplitSheet(1,&amp;quot;V&amp;quot;,&amp;quot;50%&amp;quot;);
		b_first = false;
	}
	
	initSheet();
	_this.AutoFixScreenWidth();
}

//初始化页面
function initSheet()
{
	_this.SetCellBkColor(0,-1,-1,255,255,255);
	_this.SetCellBkColor(1,-1,-1,255,255,255);
	_this.SetCellBkColor(2,-1,-1,255,255,255);
	
	_this.SetMainCellRange(1,2,0,4,7);
	_this.SetMainCellRangeAppendAuto(1,1);
	_this.SetMainCellRange(2,2,0,4,1);
	_this.SetMainCellRangeAppendAuto(2,1);
	
	loadSheetData(1);
	loadSheetData(2);
	
	_this.SetRowVisible(0,2,-1);
	_this.SetRowVisible(0,3,-1);
	_this.SetRowVisible(0,9,-1);
	
	_this.SetColVisible(0,2,-1);
	_this.SetColVisible(0,3,-1);
	
	g_sourceds = _this.GetCellText(0,6,1);
	setViewColInfo(g_sourceds);
}

//加载页面数据
function loadSheetData(sheet)
{
	var modguid = _this.GetCellText(0,2,1);
	var dsnam = &amp;quot;DATA_&amp;quot;+sheet;
	var xml = _sql.query(dsnam,&amp;quot;MODGUID=&amp;quot;+modguid);
	if (sheet == 1) {		
		_this.SetXmlDS(sheet,2,0,4,7,xml);		
	}
	else if (sheet == 2) {
		_this.SetXmlDS(sheet,2,0,4,1,xml);
	}
	setSheetColName(sheet);
}

//设置列名称
function setSheetColName(sheet)
{
	for (var i=0;i&amp;lt;_this.GetColCount(sheet);i++){
		_this.SetColName(sheet,i,&amp;quot;COL&amp;quot;+i);
	}
}

function getDimXml(sheet)
{
	var row1 = _this.GetMainCellRangeRow1(sheet);
	var col1 = _this.GetMainCellRangeCol1(sheet);
	var row2 = _this.GetMainCellRangeRow2(sheet);
	var col2 = _this.GetMainCellRangeCol2(sheet);
	return  _this.GetXml(sheet,row1,col1,row2,col2);
}

//function getTarXml()
//{
//	var row1 = _this.GetMainCellRangeRow1(2);
//	var col1 = _this.GetMainCellRangeCol1(2);
//	var row2 = _this.GetMainCellRangeRow2(2);
//	var col2 = _this.GetMainCellRangeCol2(2);
//	return  _this.GetXml(2,row1,col1,row2,col2);
//}

//修改单元格内容
function _thisOnCellModify(sheet,row,col,oldvalue,newvalue)
{
	if (sheet == 0 &amp;&amp; row == 6 &amp;&amp; col == 1) {
		g_sourceds = newvalue;
		setViewColInfo(g_sourceds);
	}
	else if ((sheet == 1 || sheet == 2) &amp;&amp; col == 0) {	//维度数据类型
		var sql = &amp;quot;select a.COLUMN_NAME COLUMN_NAME,nvl(b.COMMENTS,a.COLUMN_NAME) COMMENTS,a.DATA_TYPE &amp;quot;
			+ &amp;quot;from user_tab_columns a,user_col_comments b &amp;quot;
			+ &amp;quot;where a.Table_Name=b.Table_Name(+) and a.column_name=b.column_name(+) &amp;quot;
			+ &amp;quot;and b.table_name=UPPER(&amp;apos;&amp;quot;+g_sourceds+&amp;quot;&amp;apos;) and a.column_name=upper(&amp;apos;&amp;quot;+newvalue+&amp;quot;&amp;apos;)&amp;quot;;
		_this.QuerySQLDS(sql);
		if (sheet == 1) {
			_this.SetCellText(1,row,1,_this.XMLDS_GetString(0,&amp;quot;COMMENTS&amp;quot;));
			_this.SetCellText(1,row,2,_this.XMLDS_GetString(0,&amp;quot;DATA_TYPE&amp;quot;));
		}
		else if (sheet == 2) {
			_this.SetCellText(2,row,1,_this.XMLDS_GetString(0,&amp;quot;COMMENTS&amp;quot;));
		}
	}
}

function setViewColInfo(table_name)
{
	_sql.querytods(&amp;quot;VIEWINFO&amp;quot;,&amp;quot;table_name=&amp;quot;+table_name);
	var rowcnt = _this.XMLDS_GetRowCount();
	var listDim = _this.CreateListValue();
	if (rowcnt &amp;gt; 0) {
		for (var i=0;i&amp;lt;rowcnt;i++) {
			var colnam = _this.XMLDS_GetString(i,&amp;quot;COLUMN_NAME&amp;quot;);
			var coltyp = _this.XMLDS_GetString(i,&amp;quot;DATA_TYPE&amp;quot;);
			_this.SetListValue(listDim ,colnam,colnam);
		}
	}
	setCellMainRangeCtrl(1,0,listDim);
	setCellMainRangeCtrl(2,0,listDim);
	
	var listCtrl = _this.CreateListValue();
	//_this.SetListValue(listCtrl ,&amp;quot;COMBOBOX&amp;quot;,&amp;quot;下拉列表&amp;quot;);
	_this.SetListValue(listCtrl ,&amp;quot;LIST&amp;quot;,&amp;quot;下拉列表&amp;quot;);
	//_this.SetListValue(listCtrl ,&amp;quot;SELECTBOX&amp;quot;,&amp;quot;选择列表&amp;quot;);
	_this.SetListValue(listCtrl ,&amp;quot;SELECT&amp;quot;,&amp;quot;选择列表&amp;quot;);
	_this.SetListValue(listCtrl ,&amp;quot;DATEBOX&amp;quot;,&amp;quot;日期控件&amp;quot;);
	_this.SetListValue(listCtrl ,&amp;quot;TEXTBOX&amp;quot;,&amp;quot;文本输入框&amp;quot;);
	setCellMainRangeCtrl(1,3,listCtrl);

}

function setCellMainRangeCtrl(sheet,col,listval)
{
	for (var row=_this.GetMainCellRangeRow1(sheet);row&amp;lt;=_this.GetMainCellRangeRow2(sheet);row++) {
		_this.SetToComboBox(&amp;quot;&amp;quot;,sheet,row,col,listval);
	}
}

//test
function test()
{
	alert(getDimXml());  
}


//保存单据数据后
function _thisOnaftersave(success)
{
	_this.XMLDS_Reset();
	_this.XMLDS_Parse(success);
	var modguid = _this.XMLDS_GetString(0,&amp;quot;RETVAL&amp;quot;);
	var param = new Object();
	param.modguid = modguid;
	param.dimxml = getDimXml(1);
	param.tarxml = getDimXml(2);
	try {
		invokeOSFuncExt(&amp;quot;save&amp;quot;,param);
		return success;
	}
	catch (e) {
		alert(e);
	}
	
}


//点击按钮
function _thisOnButtonCtrlClick(id,sheet,row,col)
{
  if(id == &amp;quot;F_run_deletebutton1&amp;quot;)
  {
  	var formguid = _this.GetCellText(0,2,1);
  	var param = new Object();
  	param.formguid = formguid;
  	try
  	{
  		invokeOSFuncExt(&amp;quot;delete&amp;quot;,param);
  	}
  	catch(e)
  	{
  		alert(e);
  	}
  }
}
</GRDJSDS_VALUE></ROW>
</ROWSET>
</grdjsds><grdosds>
<ROWSET>
<ROW num="0" ><GRDOSDS_VALUE >var pub = new JavaPackage ( &amp;quot;com.xlsgrid.net.pub&amp;quot; );

// 客户端param传入的参数可以直接使用

function save()
{
	var db = null;
	var msg= &amp;quot;&amp;quot;;
	var sql = &amp;quot;&amp;quot;;
	var sql_1 = &amp;quot;&amp;quot;;
	try {
		db = new pub.EADatabase();
		//更新维度表	
		var ds = new pub.EAXmlDS(dimxml);
		sql = &amp;quot;delete from dim_dim where  refmod=&amp;apos;%s&amp;apos;&amp;quot;.format([modguid]);
		db.ExcecutSQL(sql);
		for ( var row=0;row&amp;lt;ds.getRowCount();row ++ ) {
			var id = ds.getStringAt(row,&amp;quot;COL0&amp;quot;);
			var name = ds.getStringAt(row,&amp;quot;COL1&amp;quot;);
			var datatyp = ds.getStringAt(row,&amp;quot;COL2&amp;quot;);
			var control = ds.getStringAt(row,&amp;quot;COL3&amp;quot;);
			var keyval = ds.getStringAt(row,&amp;quot;COL4&amp;quot;);
			var defval = ds.getStringAt(row,&amp;quot;COL5&amp;quot;);
			var wher = pub.EAFunc.Replace(ds.getStringAt(row,&amp;quot;COL6&amp;quot;),&amp;quot;&amp;apos;&amp;quot;,&amp;quot;&amp;apos;&amp;apos;&amp;quot;);
			var seq = ds.getStringAt(row,&amp;quot;COL7&amp;quot;);
			sql_1= &amp;quot;select count(1) from dim_dim where id = &amp;apos;&amp;quot;+id+&amp;quot;&amp;apos; and refmod = &amp;apos;&amp;quot;+modguid+&amp;quot;&amp;apos;&amp;quot;;
			sql = &amp;quot;insert into dim_dim(id,name,datatyp,refmod,control,keyval,defval,wher,seq) values(&amp;apos;%s&amp;apos;,&amp;apos;%s&amp;apos;,&amp;apos;%s&amp;apos;,&amp;apos;%s&amp;apos;,&amp;apos;%s&amp;apos;,&amp;apos;%s&amp;apos;,&amp;apos;%s&amp;apos;,&amp;apos;%s&amp;apos;,&amp;apos;%s&amp;apos;)&amp;quot;.format([id,name,datatyp,modguid,control,keyval,defval,wher,seq]);
			if (id != null &amp;&amp; id != &amp;quot;&amp;quot;) 
			{
				var count = 1.0 * db.GetSQL(sql_1);
				if(count == 0)
					db.ExcecutSQL(sql);
			}
		}	
		//更新目标表	
		var ds = new pub.EAXmlDS(tarxml);
		sql = &amp;quot;delete from dim_target where  refmod=&amp;apos;%s&amp;apos;&amp;quot;.format([modguid]);
		db.ExcecutSQL(sql);
		for ( var row=0;row&amp;lt;ds.getRowCount();row ++ ) {
			var id = ds.getStringAt(row,&amp;quot;COL0&amp;quot;);
			var name = ds.getStringAt(row,&amp;quot;COL1&amp;quot;);
			sql_1 = &amp;quot;select count(1) from dim_target where id = &amp;apos;&amp;quot;+id+&amp;quot;&amp;apos; and refmod = &amp;apos;&amp;quot;+modguid+&amp;quot;&amp;apos;&amp;quot;;
			sql = &amp;quot;insert into dim_target(id,name,refmod) values(&amp;apos;%s&amp;apos;,&amp;apos;%s&amp;apos;,&amp;apos;%s&amp;apos;)&amp;quot;.format([id,name,modguid]);
			if (id != null &amp;&amp; id != &amp;quot;&amp;quot;) 
			{
				var count = 1.0 * db.GetSQL(sql_1);
				if(count == 0)
					db.ExcecutSQL(sql);	
			}	
		}
		db.Commit();
		return &amp;quot;成功&amp;quot;;
	}
	catch ( ee ) {
		db.Rollback();
		throw new pub.EAException ( ee.toString() );
	}
	finally {
		if (db!=null) db.Close();
	}
}

//删除表的时候，一并把维度和目标删除掉
function delete()
{
	var db = null;
	var sql = &amp;quot;&amp;quot;;
	try
	{
		db = new pub.EADatabase();
		sql = &amp;quot;delete from dim_dim where refmod = &amp;apos;&amp;quot;+formguid+&amp;quot;&amp;apos;&amp;quot;;
		db.ExcecutSQL(sql);
		sql = &amp;quot;delete from dim_target where refmod = &amp;apos;&amp;quot;+formguid+&amp;quot;&amp;apos;&amp;quot;;
		db.ExcecutSQL(sql);
		
		db.Commit();
	}
	catch(e)
	{
		db.Rollback();
		throw new Exception(e);
	}
	finally
	{
		if(db != null)
			db.Close();
	}
}
</GRDOSDS_VALUE></ROW>
</ROWSET>
</grdosds><grddscds>
<ROWSET>
<ROW num="0" ><ID >DATA_1</ID><NAME >维度</NAME><DATDSC >select id,name,datatyp,control,keyval,defval,wher,seq 
from dim_dim where refmod=&amp;apos;[%MODGUID]&amp;apos;
order by seq</DATDSC><C4 >DATA_1</C4><C5 >DATA_1</C5><C6 >DATA_1</C6></ROW>
<ROW num="1" ><ID >DATA_2</ID><NAME >目标值</NAME><DATDSC >select id,name from dim_target where refmod=&amp;apos;[%MODGUID]&amp;apos;
</DATDSC><C4 ></C4><C5 ></C5><C6 ></C6></ROW>
<ROW num="2" ><ID >VIEWINFO</ID><NAME ></NAME><DATDSC >select a.COLUMN_NAME COLUMN_NAME,nvl(b.COMMENTS,a.COLUMN_NAME) COMMENTS,a.DATA_TYPE
from user_tab_columns a,user_col_comments b
where a.Table_Name=b.Table_Name(+) and a.column_name=b.column_name(+) 
and b.table_name=UPPER(&amp;apos;[%table_name]&amp;apos;) ORDER BY a.COLUMN_ID</DATDSC><C4 >VIEWINFO</C4><C5 ></C5><C6 ></C6></ROW>
</ROWSET>
</grddscds><fldhdr>
<ROWSET>
<ROW num="0" ><BILID >1单据编号</BILID><STAT >0单据状态</STAT><SUBTYP >0子类型</SUBTYP><CORPID >0往来单位编号</CORPID><CORPNAM >0往来单位名称</CORPNAM><LOCID >0仓库|部门编号</LOCID><LOCNAM >0仓库|部门名称</LOCNAM><DAT >0单据日期</DAT><CRTUSR >1录入人</CRTUSR><CRTUSRNAM >0录入人姓名</CRTUSRNAM><CRTDAT >0录入日期</CRTDAT><CHKUSR >1审核人</CHKUSR><CHKUSRNAM >0审核人姓名</CHKUSRNAM><CHKDAT >0审核日期</CHKDAT><SUMQTY >0合计金额</SUMQTY><SUMMNY >0合计金额</SUMMNY><REFID1 >0扩展字段</REFID1><REFNAM1 >0扩展字段</REFNAM1><REFID2 >0扩展字段</REFID2><REFNAM2 >0扩展字段</REFNAM2><REFID3 >0扩展字段</REFID3><REFNAM3 >0扩展字段</REFNAM3><REFID4 >0扩展字段</REFID4><REFNAM4 >0扩展字段</REFNAM4><REFID5 >0扩展字段</REFID5><REFNAM5 >0扩展字段</REFNAM5><REFID6 >0扩展字段</REFID6><REFNAM6 >0扩展字段</REFNAM6><NOTE >0备注</NOTE></ROW>
</ROWSET>
</fldhdr><flddtl>
<ROWSET>
<ROW num="0" ><SEQID >1明细序号</SEQID><ITMID >1品种编号</ITMID><ITMNAM >0品种名称</ITMNAM><ITEMPC >0品种批次号</ITEMPC><ITMSPC >0规格</ITMSPC><UNIT >0计量单位</UNIT><SMLUNT >0小计量单位</SMLUNT><UNTNUM >0大单位转小单位因子</UNTNUM><PRICE >0价格</PRICE><QTY >0数量</QTY><TAXTYP >0税率类型</TAXTYP><NOTAXMNY >0不含税税额</NOTAXMNY><TAXMNY >0税额</TAXMNY><MNY >0下单金额</MNY><REFID1 >0扩展字段</REFID1><REFNAM1 >0扩展字段</REFNAM1><REFID2 >0扩展字段</REFID2><REFNAM2 >0扩展字段</REFNAM2><REFID3 >0扩展字段</REFID3><REFNAM3 >0扩展字段</REFNAM3><REFID4 >0扩展字段</REFID4><REFNAM4 >0扩展字段</REFNAM4><REFID5 >0扩展字段</REFID5><REFNAM5 >0扩展字段</REFNAM5></ROW>
</ROWSET>
</flddtl></mdroot>